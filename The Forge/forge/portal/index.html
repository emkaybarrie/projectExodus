<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <meta name="theme-color" content="#0a0e17">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Forante">
  <meta name="description" content="Institutional OS Console for Forge governance">
  <title>Forante Portal</title>
  <!-- PWA Manifest -->
  <link rel="manifest" href="manifest.json">
  <!-- Icons -->
  <link rel="icon" type="image/svg+xml" href="icons/icon.svg">
  <link rel="apple-touch-icon" href="icons/icon.svg">
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <!-- PWA Install Banner -->
  <div id="pwa-install-banner" class="pwa-banner hidden">
    <div class="pwa-banner-content">
      <span class="pwa-banner-icon">&#127970;</span>
      <div class="pwa-banner-text">
        <strong>Install Forante Portal</strong>
        <span>Add to home screen for quick access</span>
      </div>
    </div>
    <div class="pwa-banner-actions">
      <button id="pwa-install-btn" class="pwa-btn primary">Install</button>
      <button id="pwa-dismiss-btn" class="pwa-btn">Later</button>
    </div>
  </div>

  <div class="portal" data-portal-type="forante">
    <!-- Command Centre Header -->
    <header class="portal-header command-header">
      <div class="header-left">
        <div class="logo" onclick="navigateTo('command')" style="cursor: pointer;">
          <span class="logo-icon">&#127970;</span>
          <span class="logo-text">Forante</span>
        </div>
      </div>
      <div class="header-centre">
        <!-- World Switcher (FCL v2 World Model) -->
        <button class="entity-switcher" id="entity-switcher" onclick="toggleEntityPicker()">
          <span class="entity-icon" id="current-entity-icon">&#127970;</span>
          <span class="entity-name" id="current-entity-name">Forante</span>
          <span class="entity-chevron">&#9662;</span>
        </button>
      </div>
      <div class="header-right">
        <!-- Network Health Dots -->
        <div class="health-dots" id="health-dots">
          <span class="health-dot healthy" title="Forante"></span>
          <span class="health-dot healthy" title="Forge"></span>
          <span class="health-dot healthy" title="Entities"></span>
        </div>
      </div>
    </header>

    <!-- World Picker Dropdown (FCL v2 World Model) -->
    <div class="entity-picker-dropdown hidden" id="entity-picker-dropdown">
      <div class="entity-picker-header">
        <span>Enter World</span>
        <button class="entity-picker-close" onclick="toggleEntityPicker()">&#10005;</button>
      </div>
      <div class="entity-picker-list" id="entity-picker-list">
        <!-- Populated by app.js with Worlds and Products -->
      </div>
    </div>

    <!-- Dynamic Content Area -->
    <main id="portal-content">
      <!-- Content rendered by app.js -->
    </main>

    <!-- Bottom Tab Navigation (Command Centre) -->
    <nav class="bottom-nav" id="bottom-nav">
      <button class="nav-tab active" data-tab="command" onclick="navigateTo('command')">
        <span class="nav-tab-icon">&#127970;</span>
        <span class="nav-tab-label">Command</span>
      </button>
      <button class="nav-tab" data-tab="lifecycle" onclick="navigateTo('lifecycle')">
        <span class="nav-tab-icon">&#128260;</span>
        <span class="nav-tab-label">Lifecycle</span>
      </button>
      <button class="nav-tab" data-tab="ops" onclick="navigateTo('ops')">
        <span class="nav-tab-icon">&#128736;</span>
        <span class="nav-tab-label">Ops</span>
      </button>
      <button class="nav-tab" data-tab="config" onclick="navigateTo('config')">
        <span class="nav-tab-icon">&#9881;</span>
        <span class="nav-tab-label">Config</span>
      </button>
    </nav>

    <!-- Footer (hidden when bottom nav active) -->
    <footer class="portal-footer hidden-mobile">
      <p>Forante Portal v3.0 &middot; Institutional OS Console</p>
      <p class="footer-timestamp" id="timestamp"></p>
    </footer>
  </div>

  <script type="module" src="app.js"></script>

  <!-- PWA Service Worker & Install Logic -->
  <script>
    // Service Worker Registration
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('./sw.js')
          .then((reg) => console.log('[PWA] Service Worker registered:', reg.scope))
          .catch((err) => console.warn('[PWA] Service Worker registration failed:', err));
      });
    }

    // PWA Install Prompt
    let deferredPrompt;
    const installBanner = document.getElementById('pwa-install-banner');
    const installBtn = document.getElementById('pwa-install-btn');
    const dismissBtn = document.getElementById('pwa-dismiss-btn');
    const DISMISS_KEY = 'forante-pwa-dismissed';
    const DISMISS_DURATION = 7 * 24 * 60 * 60 * 1000; // 7 days

    // Check if already installed or dismissed
    function shouldShowBanner() {
      // Check if running as PWA
      if (window.matchMedia('(display-mode: standalone)').matches) return false;
      if (window.navigator.standalone === true) return false;

      // Check if dismissed recently
      const dismissed = localStorage.getItem(DISMISS_KEY);
      if (dismissed) {
        const dismissedAt = parseInt(dismissed, 10);
        if (Date.now() - dismissedAt < DISMISS_DURATION) return false;
      }
      return true;
    }

    // Show install banner
    function showInstallBanner() {
      if (!shouldShowBanner()) return;
      installBanner.classList.remove('hidden');
      installBanner.classList.add('show');
    }

    // Hide install banner
    function hideInstallBanner() {
      installBanner.classList.remove('show');
      setTimeout(() => installBanner.classList.add('hidden'), 300);
    }

    // Listen for beforeinstallprompt event
    window.addEventListener('beforeinstallprompt', (e) => {
      e.preventDefault();
      deferredPrompt = e;
      showInstallBanner();
    });

    // Install button click
    installBtn?.addEventListener('click', async () => {
      if (!deferredPrompt) return;
      deferredPrompt.prompt();
      const { outcome } = await deferredPrompt.userChoice;
      console.log('[PWA] User response:', outcome);
      deferredPrompt = null;
      hideInstallBanner();
    });

    // Dismiss button click
    dismissBtn?.addEventListener('click', () => {
      localStorage.setItem(DISMISS_KEY, Date.now().toString());
      hideInstallBanner();
    });

    // Hide banner when app is installed
    window.addEventListener('appinstalled', () => {
      console.log('[PWA] App installed');
      hideInstallBanner();
      deferredPrompt = null;
    });

    // For iOS - show banner after delay (no beforeinstallprompt on iOS)
    if (/iPhone|iPad|iPod/.test(navigator.userAgent) && !window.navigator.standalone) {
      setTimeout(() => {
        if (shouldShowBanner()) {
          installBanner.classList.remove('hidden');
          installBanner.classList.add('show');
          // Change button text for iOS
          if (installBtn) {
            installBtn.textContent = 'How to Install';
            installBtn.onclick = () => {
              alert('To install: tap the Share button, then "Add to Home Screen"');
            };
          }
        }
      }, 3000);
    }
  </script>
</body>
</html>
