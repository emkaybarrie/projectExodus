<!DOCTYPE html>
<html>
<head>
  <title>Linking...</title>
</head>
<body>
<script type="module">
  const p = new URLSearchParams(location.search);
  const code = p.get('code');
  const uid  = p.get('state');

  if (code && uid) {
    const saved = sessionStorage.getItem('tl_redirect_uri');
    const redirect_uri = saved || (location.origin + location.pathname); // no query string

    console.log("Posting to exchangeToken:", { code, uid, redirect_uri });

    const r = await fetch("https://exchangetoken-frxqsvlhwq-nw.a.run.app", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ code, uid, redirect_uri })
    });

    const raw = await r.text();
    let data; try { data = JSON.parse(raw); } catch { data = { error: 'non_json', raw }; }

    if (!r.ok || !data.success) {
      console.error('Token exchange failed:', data);
      alert('Token exchange failed. Check console for details.');
    } else {
      window.location.href = "dashboard_v4.html";
    }
  } else {
    console.error("Missing code or state in redirect URL.");
  }
</script>


</body>
</html>
