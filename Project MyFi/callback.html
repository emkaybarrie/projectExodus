<!DOCTYPE html>
<html>
<head>
  <title>Linking...</title>
</head>
<body>
<script type="module">
  const params = new URLSearchParams(window.location.search);
  const code = params.get('code');
  const uid = params.get('state');

  if (code && uid) {
    const payload = { code, uid, redirect_uri: window.location.href };
    console.log("Posting to exchangeToken:", payload);

    const r = await fetch("https://exchangetoken-frxqsvlhwq-nw.a.run.app", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload)
    });

    const raw = await r.text();
    let data;
    try { data = JSON.parse(raw); } catch { data = { error: 'non_json', raw }; }

    if (!r.ok || !data.success) {
      console.error('Token exchange failed:', data);
      alert('Token exchange failed. Check console for details.');
    } else {
      window.location.href = "dashboard_v2.html";
    }
  } else {
    console.error("Missing code or state in redirect URL.");
  }
</script>


</body>
</html>
