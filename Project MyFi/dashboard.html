<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Vitals HUD</title>
  <!-- Main app logic -->
    <script type="module" src="js/dashboard.js" defer></script>
  <!-- Style Sheets -->
  <link rel="stylesheet" href="vitals_v9.css" />
  <link rel="stylesheet" href="pwa.css" />
  <!-- Add in <head> -->
  <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@600&family=Crimson+Pro:wght@400;600&display=swap" rel="stylesheet">
  <!-- PWA Module -->
  <link rel="manifest" href="manifest.json">

</head>
<body>
  
  
<div id="installBanner" class="install-banner" style="display: none;">
  <span>üì≤ Install MyFi</span>
  <div class="buttons">
    <button id="installBtn">Install</button>
    <button id="dismissInstall" class="dismiss-btn" title="Dismiss">‚úñ</button>
  </div>
</div>


<div class="vitals-container">
  
    <div id="background-layer"></div>
    <div class="starfield-overlay"></div>
    <h1>VITALS</h1>

  <div class="top-section">
    <img src="./assets/portraits/default.png" alt="Avatar Portrait" class="portrait" />

    <div class="vitals-bars">
      <div id="vital-health">
        <div class="bar health">
          <span class="bar-label">Health</span>
          <div class="bar-fill" style="width: 0%;"></div>
          <span class="bar-value">0 / 0</span>
        </div>
      </div>

      <div id="vital-mana">
        <div class="bar mana">
          <span class="bar-label">Mana</span>
          <div class="bar-fill" style="width: 0%;"></div>
          <span class="bar-value">0 / 0</span>
        </div>
      </div>
    </div>
  </div>

  <div id="vital-stamina">
    <div class="bar stamina">
      <span class="bar-label">Stamina</span>
      <div class="bar-fill" style="width: 0%;"></div>
      <span class="bar-value">0 / 0</span>
    </div>
  </div>

  <div class="skills-row">
    <div class="skill-slot">üî•</div>
    <div class="skill-slot">üíß</div>
    <div class="skill-slot locked">üîí</div>
    <div class="skill-slot">‚ö°</div>
  </div>

  <div class="update-log-box">
    <div class="update-log">
      <h2>UPDATE LOG</h2>
      <ul>
        <li><span class="health-damage">-15 Health</span> Subscription Fee</li>
        <li><span class="mana-damage">-25 Mana</span> Dining Out</li>
        <li><span class="stamina-damage">-30 Stamina</span> Loan Payment</li>
      </ul>
    </div>
  </div>

  <button class="tag-button">TAG TRANSACTION</button>

  <div id="vital-essence">
    <div class="bar essence">
      <span class="bar-label">Essence</span>
      <div class="bar-fill" style="width: 0%;"></div>
      <span class="bar-value">0 / 0</span>
    </div>
  </div>

  <div class="actions">
  <button class="side-btn" id="settings-btn" title="Settings">‚öôÔ∏è</button>
  <button class="main-btn" id="essence-btn" title="Use Essence"> </button>
  <button class="side-btn" id="refresh-btn" title="Refresh">üîÑ</button>
</div>

</div>

  <!-- ============ Modal & Settings Menu (Drop-in) ============ -->
<style>
  :root {
    --modal-backdrop: rgba(10, 12, 16, 0.55);
    --modal-bg: #0f1115;
    --modal-card: #141821;
    --modal-text: #e9edf1;
    --modal-muted: #94a3b8;
    --modal-accent: #6ee7ff;
    --border: #1f2430;
    --radius: 16px;
  }
  .modal-backdrop {
    position: fixed; inset: 0;
    background: var(--modal-backdrop);
    display: none;
    align-items: center; justify-content: center;
    z-index: 1000;
  }
  .modal-backdrop[data-open="true"] { display: flex; }
  .modal {
    width: min(720px, 92vw);
    max-height: 86vh;
    background: linear-gradient(145deg, var(--modal-card), var(--modal-bg));
    color: var(--modal-text);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    box-shadow: 0 10px 40px rgba(0,0,0,.45);
    display: grid;
    grid-template-columns: 220px 1fr;
    overflow: hidden;
    transform: translateY(8px);
    opacity: 0;
    transition: opacity .15s ease, transform .15s ease;
  }
  .modal-backdrop[data-open="true"] .modal { opacity: 1; transform: translateY(0); }
  .modal__menu {
    background: rgba(255,255,255,0.02);
    border-right: 1px solid var(--border);
    padding: 10px;
    overflow: auto;
  }
  .modal__menu h3 {
    font: 600 13px/1.1 system-ui, sans-serif;
    letter-spacing: .08em; text-transform: uppercase; color: var(--modal-muted);
    padding: 8px 10px; margin: 2px 0 6px;
  }
  .menu__btn {
    width: 100%; text-align: left; padding: 12px 12px;
    border-radius: 10px; border: 1px solid transparent;
    background: transparent; color: var(--modal-text); cursor: pointer;
    font: 500 14px/1.25 system-ui, sans-serif;
  }
  .menu__btn:hover, .menu__btn[aria-current="true"] {
    background: rgba(110,231,255,0.08);
    border-color: rgba(110,231,255,0.3);
  }
  .modal__body {
    display: grid; grid-template-rows: auto 1fr auto; min-height: 360px;
  }
  .modal__header { padding: 14px 16px; border-bottom: 1px solid var(--border); }
  .modal__title { font: 700 16px system-ui, sans-serif; }
  .modal__content { padding: 14px 16px; overflow: auto; }
  .modal__footer {
    padding: 12px 16px; border-top: 1px solid var(--border);
    display: flex; gap: 8px; justify-content: flex-end;
  }
  .btn {
    appearance: none; border: 1px solid var(--border);
    background: rgba(255,255,255,0.03); color: var(--modal-text);
    padding: 10px 14px; border-radius: 10px; cursor: pointer; font: 600 14px system-ui;
  }
  .btn--accent { border-color: rgba(110,231,255,0.4); background: rgba(110,231,255,0.12); }
  .field { display: grid; gap: 6px; margin-bottom: 12px; }
  .field label { font: 600 12px/1 system-ui; color: var(--modal-muted); letter-spacing: .02em; }
  .input, .select {
    width: 100%; border: 1px solid var(--border); background: #0b0d12;
    color: var(--modal-text); border-radius: 10px; padding: 10px 12px; font: 14px system-ui;
  }
  .helper { color: var(--modal-muted); font-size: 12px; margin-top: -6px; margin-bottom: 12px; }
  @media (max-width: 640px) {
    .modal { grid-template-columns: 1fr; width: 96vw; }
    .modal__menu { order: 2; border-right: none; border-top: 1px solid var(--border); }
  }
</style>

<div class="modal-backdrop" id="appModalBackdrop" role="dialog" aria-modal="true" aria-hidden="true">
  <div class="modal" role="document">
    <nav class="modal__menu" aria-label="Settings menu">
      <h3>Settings</h3>
      <div id="modalMenu"></div>
    </nav>
    <section class="modal__body">
      <header class="modal__header">
        <div class="modal__title" id="modalTitle">Menu</div>
      </header>
      <div class="modal__content" id="modalContent"></div>
      <footer class="modal__footer" id="modalFooter">
        <button class="btn" data-action="close">Close</button>
      </footer>
    </section>
  </div>
</div>

<script>
/* ========== Tiny Modal Core (reusable) ========== */
const Modal = (() => {
  const backdrop = document.getElementById('appModalBackdrop');
  const titleEl  = document.getElementById('modalTitle');
  const contentEl = document.getElementById('modalContent');
  const footerEl = document.getElementById('modalFooter');
  const menuEl = document.getElementById('modalMenu');

  let lastFocused = null;
  let currentKey = null;
  let menuConfig = {};

  // Focus trap
  function trap(e) {
    if (e.key !== 'Tab') return;
    const focusables = backdrop.querySelectorAll('button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])');
    const list = Array.from(focusables).filter(el => !el.hasAttribute('disabled') && el.offsetParent !== null);
    const first = list[0], last = list[list.length - 1];
    if (e.shiftKey && document.activeElement === first) { e.preventDefault(); last.focus(); }
    else if (!e.shiftKey && document.activeElement === last) { e.preventDefault(); first.focus(); }
  }

  function open(defaultKey) {
    lastFocused = document.activeElement;
    backdrop.dataset.open = "true";
    backdrop.removeAttribute('aria-hidden');
    document.addEventListener('keydown', onKey);
    backdrop.addEventListener('keydown', trap);
    if (defaultKey && menuConfig[defaultKey]) switchTo(defaultKey);
    else if (Object.keys(menuConfig).length) switchTo(Object.keys(menuConfig)[0]);
    // Focus first interactive
    setTimeout(() => {
      const first = backdrop.querySelector('button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])');
      if (first) first.focus();
    }, 0);
  }

  function close() {
    backdrop.dataset.open = "false";
    backdrop.setAttribute('aria-hidden', 'true');
    document.removeEventListener('keydown', onKey);
    backdrop.removeEventListener('keydown', trap);
    if (lastFocused && typeof lastFocused.focus === 'function') lastFocused.focus();
  }

  function onKey(e) {
    if (e.key === 'Escape') close();
  }

  backdrop.addEventListener('click', (e) => {
    if (e.target === backdrop) close(); // click outside
  });
  footerEl.addEventListener('click', (e) => {
    if (e.target.matches('[data-action="close"]')) close();
  });

  function setMenu(config) {
    menuConfig = config;
    renderMenu();
  }

  function renderMenu() {
    menuEl.innerHTML = '';
    Object.entries(menuConfig).forEach(([key, def]) => {
      const b = document.createElement('button');
      b.className = 'menu__btn';
      b.type = 'button';
      b.textContent = def.label;
      b.setAttribute('data-key', key);
      b.addEventListener('click', () => switchTo(key));
      menuEl.appendChild(b);
    });
    highlightCurrent();
  }

  function highlightCurrent() {
    menuEl.querySelectorAll('.menu__btn').forEach(btn => {
      btn.setAttribute('aria-current', btn.dataset.key === currentKey ? 'true' : 'false');
    });
  }

  function switchTo(key) {
    const def = menuConfig[key];
    if (!def) return;
    currentKey = key;
    titleEl.textContent = def.title || def.label;
    contentEl.replaceChildren(...[].concat(def.render()));
    footerEl.replaceChildren(...(def.footer?.() || defaultFooter()));
    highlightCurrent();
  }

  function defaultFooter() {
    const closeBtn = html`<button class="btn" data-action="close" type="button">Close</button>`;
    return [closeBtn];
  }

  // Tiny html helper
  function html(strings, ...values) {
    const tpl = document.createElement('template');
    tpl.innerHTML = strings.map((s, i) => s + (values[i] ?? '')).join('').trim();
    return tpl.content.firstElementChild;
  }

  return { open, close, setMenu, switchTo, el: { backdrop, titleEl, contentEl, footerEl, menuEl }, html };
})();

/* ========== Settings Menu Config (data-driven) ========== */
const SettingsMenu = {
  setIncome: {
    label: 'Set Income',
    title: 'Set Daily/Monthly Income',
    render() {
      return [
        elField('Income Amount', 'number', 'incomeAmount', { min: 0, step: '0.01', placeholder: 'e.g. 3200.00' }),
        elSelect('Cadence', 'incomeCadence', [
          ['monthly','Monthly'], ['weekly','Weekly'], ['daily','Daily']
        ]),
        helper('This updates your regen baseline and HUD projections.')
      ];
    },
    footer() {
      return [ primary('Save', () => emit('income:save')),
               cancel() ];
    }
  },
  setCoreExpenses: {
    label: 'Set Core Expenses',
    title: 'Set Core Expenses',
    render() {
      return [
        elField('Core Expenses Amount', 'number', 'coreAmount', { min: 0, step: '0.01', placeholder: 'e.g. 1850.00' }),
        elSelect('Cadence', 'coreCadence', [
          ['monthly','Monthly'], ['weekly','Weekly']
        ]),
        helper('Core expenses inform Health/Mana/Stamina baselines.')
      ];
    },
    footer() {
      return [ primary('Save', () => emit('core:save')),
               cancel() ];
    }
  },
  addTransaction: {
    label: 'Add Transaction',
    title: 'Add Transaction',
    render() {
      return [
        elField('Description', 'text', 'txDesc', { placeholder: 'e.g. Groceries' }),
        elField('Amount', 'number', 'txAmount', { min: 0, step: '0.01', placeholder: 'e.g. 23.40' }),
        elSelect('Type', 'txType', [['debit','Expense'],['credit','Income']]),
        elSelect('Pool (optional)', 'txPool', [['','Unassigned'],['stamina','Stamina'],['mana','Mana'],['health','Health']]),
        elField('Date', 'date', 'txDate', {}),
        helper('If left unassigned, your fallback logic will route it (Stamina first, overflow to Health).')
      ];
    },
    footer() {
      return [ primary('Add', () => emit('tx:add')),
               cancel() ];
    }
  },
  connectAccount: {
    label: 'Connect Account',
    title: 'Connect a Bank Account',
    render() {
      return [
        p('Connect a bank via TrueLayer to sync transactions automatically.'),
        Modal.html`<button class="btn btn--accent" type="button" id="btnStartOAuth">Start Connection</button>`,
        helper('You‚Äôll be redirected to your bank to authorise access.')
      ];
    },
    footer() { return [ cancel() ]; }
  },
  logout: {
    label: 'Log Out',
    title: 'Log Out',
    render() {
      return [
        p('<strong>Are you sure?</strong> You‚Äôll be signed out from this device.'),
      ];
    },
    footer() {
      return [ danger('Log Out', () => emit('auth:logout')),
               cancel('Cancel') ];
    }
  }
};

/* ========== Element helpers & event wiring ========== */
function elField(labelTxt, type, id, attrs = {}) {
  const wrap = document.createElement('div'); wrap.className = 'field';
  const label = document.createElement('label'); label.setAttribute('for', id); label.textContent = labelTxt;
  const input = document.createElement('input'); input.className = 'input'; input.type = type; input.id = id; Object.assign(input, attrs);
  wrap.append(label, input); return wrap;
}
function elSelect(labelTxt, id, options) {
  const wrap = document.createElement('div'); wrap.className = 'field';
  const label = document.createElement('label'); label.setAttribute('for', id); label.textContent = labelTxt;
  const select = document.createElement('select'); select.className = 'select'; select.id = id;
  options.forEach(([val, txt]) => { const o = document.createElement('option'); o.value = val; o.textContent = txt; select.appendChild(o); });
  wrap.append(label, select); return wrap;
}
function helper(text) { const s = document.createElement('div'); s.className = 'helper'; s.innerHTML = text; return s; }
function p(text) { const el = document.createElement('div'); el.className = 'helper'; el.innerHTML = text; return el; }

function btn(label, className, onClick) { const b = document.createElement('button'); b.type='button'; b.className=`btn ${className||''}`; b.textContent=label; b.addEventListener('click', onClick); return b; }
function primary(label, onClick){ return btn(label, 'btn--accent', onClick); }
function cancel(label='Close'){ const b = btn(label, '', () => Modal.close()); b.setAttribute('data-action','close'); return b; }
function danger(label, onClick){ return btn(label, '', onClick); }

/* Event bus: dispatch granular events the app can handle */
function emit(type) {
  // Collect current form values into detail for convenience
  const values = {};
  Modal.el.contentEl.querySelectorAll('input, select, textarea').forEach(i => { values[i.id] = i.value; });
  const evt = new CustomEvent(type, { detail: values });
  window.dispatchEvent(evt);
}

/* ========== Bootstrapping ========== */
// Register the menu
Modal.setMenu(SettingsMenu);

// Hook up the Settings button on the Vitals screen
document.getElementById('settings-btn')?.addEventListener('click', () => {
 //Modal.open('setIncome'); // default view when opening (pick any key)
  Modal.open(); // default view when opening (pick any key)
});

// Example: handle emitted actions in your app layer
window.addEventListener('income:save', (e) => {
  // TODO: persist to Firestore + recompute regen baseline
  // e.detail = { incomeAmount, incomeCadence }
  console.log('Save income', e.detail);
});
window.addEventListener('core:save', (e) => {
  console.log('Save core expenses', e.detail);
});
window.addEventListener('tx:add', (e) => {
  console.log('Add transaction', e.detail);
});
window.addEventListener('auth:logout', () => {
  console.log('Log out clicked');
  // TODO: firebase.auth().signOut() ...
  Modal.close();
});
document.addEventListener('click', (e) => {
  if (e.target && e.target.id === 'btnStartOAuth') {
    console.log('Start TrueLayer OAuth flow');
    // TODO: trigger your backend function to generate auth URL
  }
});
</script>
<!-- ============ /Modal & Settings Menu ============ -->

</body>
</html>
