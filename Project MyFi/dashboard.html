<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Vitals HUD</title>
  <!-- Main app logic -->
    <script type="module" src="js/dashboard.js" defer></script>
  <!-- Style Sheets -->
  <link rel="stylesheet" href="vitals_v9.css" />
  <link rel="stylesheet" href="pwa.css" />
  <!-- Add in <head> -->
  <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@600&family=Crimson+Pro:wght@400;600&display=swap" rel="stylesheet">
  <!-- PWA Module -->
  <link rel="manifest" href="manifest.json">

</head>
<body>
  
  
<div id="installBanner" class="install-banner" style="display: none;">
  <span>üì≤ Install MyFi</span>
  <div class="buttons">
    <button id="installBtn">Install</button>
    <button id="dismissInstall" class="dismiss-btn" title="Dismiss">‚úñ</button>
  </div>
</div>


<div class="vitals-container">
  
    <div id="background-layer"></div>
    <div class="starfield-overlay"></div>
    <h1>VITALS</h1>

  <div class="top-section">
    <img src="./assets/portraits/default.png" alt="Avatar Portrait" class="portrait" />

    <div class="vitals-bars">
      <div id="vital-health">
        <div class="bar health">
          <span class="bar-label">Health</span>
          <div class="bar-fill" style="width: 0%;"></div>
          <span class="bar-value">0 / 0</span>
        </div>
      </div>

      <div id="vital-mana">
        <div class="bar mana">
          <span class="bar-label">Mana</span>
          <div class="bar-fill" style="width: 0%;"></div>
          <span class="bar-value">0 / 0</span>
        </div>
      </div>
    </div>
  </div>

  <div id="vital-stamina">
    <div class="bar stamina">
      <span class="bar-label">Stamina</span>
      <div class="bar-fill" style="width: 0%;"></div>
      <span class="bar-value">0 / 0</span>
    </div>
  </div>

  <div class="skills-row">
    <div class="skill-slot">üî•</div>
    <div class="skill-slot">üíß</div>
    <div class="skill-slot locked">üîí</div>
    <div class="skill-slot">‚ö°</div>
  </div>

  <div class="update-log-box">
    <div class="update-log">
      <h2>UPDATE LOG</h2>
      <ul>
        <li><span class="health-damage">-15 Health</span> Subscription Fee</li>
        <li><span class="mana-damage">-25 Mana</span> Dining Out</li>
        <li><span class="stamina-damage">-30 Stamina</span> Loan Payment</li>
      </ul>
    </div>
  </div>

  <button class="tag-button">TAG TRANSACTION</button>

  <div id="vital-essence">
    <div class="bar essence">
      <span class="bar-label">Essence</span>
      <div class="bar-fill" style="width: 0%;"></div>
      <span class="bar-value">0 / 0</span>
    </div>
  </div>

  <div class="actions">
  <button class="side-btn" id="settings-btn" title="Settings">‚öôÔ∏è</button>
  <button class="main-btn" id="essence-btn" title="Use Essence"> </button>
  <button class="side-btn" id="refresh-btn" title="Refresh">üîÑ</button>
</div>

</div>

<!-- ============ Modal (Sidebar kept on Mobile; Content Squishes Responsively) ============ -->
<style>
  /* ---- Theme tokens ---- */
  :root{
    --modal-backdrop: rgba(10,12,16,.55);
    --modal-bg:#0f1115; --modal-card:#141821; --modal-text:#e9edf1; --modal-muted:#94a3b8;
    --modal-accent:#6ee7ff; --border:#1f2430; --radius:16px;

    --sidebar-min-mobile: 150px;  /* minimum sidebar width on mobile */
    --sidebar-max-mobile: 35%;    /* max percentage sidebar can take on mobile */

    /* Presets you can try */
    /* Narrow sidebar */
    /* --sidebar-min-mobile: 160px; --sidebar-max-mobile: 40%; */
    /* Wide sidebar */
    /* --sidebar-min-mobile: 200px; --sidebar-max-mobile: 52%; */
  }

  /* ---- Backdrop, shell ---- */
  .modal-backdrop{position:fixed;inset:0;background:var(--modal-backdrop);display:none;align-items:center;justify-content:center;z-index:1000;}
  .modal-backdrop[data-open="true"]{display:flex;}
  .modal{
    width:min(720px,92vw);
    max-height:86svh; /* mobile toolbar friendly */
    background:linear-gradient(145deg,var(--modal-card),var(--modal-bg));
    color:var(--modal-text);
    border:1px solid var(--border); border-radius:var(--radius);
    box-shadow:0 10px 40px rgba(0,0,0,.45);

    /* KEY: keep sidebar visible on all sizes.
       Left column flexible with min (so it doesn't vanish),
       right column can shrink all the way down. */
    display:grid;
    grid-template-columns: minmax(140px, 35%) minmax(0, 1fr);
    overflow:hidden;

    transform:translateY(8px); opacity:0; transition:opacity .15s ease, transform .15s ease;
  }
  .modal-backdrop[data-open="true"] .modal{opacity:1; transform:translateY(0);}

  /* ---- Sidebar (always visible) ---- */
  .modal__menu{
    background:rgba(255,255,255,.02);
    border-right:1px solid var(--border);
    padding:10px;
    overflow:auto;
  }
  .modal__menu h3{
    font:600 13px/1.1 system-ui,sans-serif;
    letter-spacing:.08em; text-transform:uppercase; color:var(--modal-muted);
    padding:8px 10px; margin:2px 0 6px;
  }
  .menu__btn{
    width:100%; text-align:left; padding:12px;
    border-radius:10px; border:1px solid transparent;
    background:transparent; color:var(--modal-text); cursor:pointer;
    font:500 14px/1.25 system-ui;
  }
  .menu__btn:hover,
  .menu__btn[aria-current="true"]{
    background:rgba(110,231,255,.08);
    border-color:rgba(110,231,255,.3);
  }

  /* ---- Body layout (header + content + footer) ---- */
  .modal__body{
    display:grid;
    grid-template-rows: auto minmax(0, 1fr) auto; /* content scrolls only */
    min-width:0; /* CRITICAL for shrinking on small screens */
    min-height:360px;
  }
  .modal__header{
    padding:12px 12px; border-bottom:1px solid var(--border);
    display:flex; align-items:center; gap:8px;
  }
  .modal__title{ font:700 16px system-ui,sans-serif; }
  .modal__back{ display:none; } /* back not needed with constant sidebar */

  .modal__content{
    padding: 0.75rem 1.5rem;  /* top/bottom, left/right */
    box-sizing: border-box; /* keep padding inside the width */
    overflow:auto; 
    min-width:0; /* allow inputs to shrink */
  }

  .modal__content form {
    padding-bottom: 1rem;
  }
  .modal__footer{
    padding:10px 12px; border-top:1px solid var(--border);
    display:flex; gap:8px; justify-content:flex-end;
  }

  /* ---- Inputs & buttons ---- */
  .btn{appearance:none; border:1px solid var(--border); background:rgba(255,255,255,.03); color:var(--modal-text);
       padding:10px 14px; border-radius:10px; cursor:pointer; font:600 14px system-ui;}
  .btn--accent{border-color:rgba(110,231,255,.4); background:rgba(110,231,255,.12);}

  .field{display:grid; gap:6px; margin-bottom:12px; min-width:0;}
  .field label{font:600 12px/1 system-ui; color:var(--modal-muted); letter-spacing:.02em;}
  .input,.select{
    width:100%; max-width:100%; /* prevent overflow */
    border:1px solid var(--border); background:#0b0d12; color:var(--modal-text);
    border-radius:10px; padding:10px 12px; font:14px system-ui; min-width:0;
  }
  .helper{color:var(--modal-muted); font-size:12px; margin-top:-6px; margin-bottom:12px;}

  /* ---- Mobile tweaks: give sidebar a bit more room, tighten paddings ---- */
  @media (max-width:640px){
    .modal{
      grid-template-columns: minmax(var(--sidebar-min-mobile), var(--sidebar-max-mobile)) minmax(0, calc(100% - var(--sidebar-max-mobile)));
      width: 96vw; /* a touch wider on tiny screens */
    }
    .menu__btn{ padding:10px; font-size:13px; }
    .modal__header{ padding:10px 10px; }
    .modal__content{ 
      padding-top: 0.75rem;
      padding-bottom: 0.75rem;
      padding-left: 1rem;
      padding-right: 2rem; /* extra space on the right */
      box-sizing: border-box;
    }
    .btn{ padding:9px 12px; font-size:13px; }
  }
</style>

<div class="modal-backdrop" id="appModalBackdrop" role="dialog" aria-modal="true" aria-hidden="true">
  <div class="modal" role="document">
    <!-- Sidebar: stays visible on all sizes -->
    <nav class="modal__menu" aria-label="Settings menu">
      <h3>Settings</h3>
      <div id="modalMenu"></div>
    </nav>

    <!-- Right side: header + content + footer -->
    <section class="modal__body">
      <header class="modal__header">
        <!-- Back button kept in DOM for future variants; hidden by CSS -->
        <button class="btn modal__back" type="button" aria-label="Back">Back</button>
        <div class="modal__title" id="modalTitle">Menu</div>
      </header>

      <div class="modal__content" id="modalContent"></div>

      <footer class="modal__footer" id="modalFooter">
        <button class="btn" data-action="close">Close</button>
      </footer>
    </section>
  </div>
</div>

<script>
/* ========================================================================================
   Modal Core (sidebar always visible)
   - Responsive grid: left column has a floor; right column can "squish"
   - Accessible: focus trap, ESC to close, click-outside to close
   - Data-driven views (menuConfig)
======================================================================================== */
const Modal = (() => {
  // ---- DOM refs ----
  const backdrop  = document.getElementById('appModalBackdrop');
  const titleEl   = document.getElementById('modalTitle');
  const contentEl = document.getElementById('modalContent');
  const footerEl  = document.getElementById('modalFooter');
  const menuEl    = document.getElementById('modalMenu');

  let lastFocused = null;
  let currentKey = null;
  let menuConfig = {}; // { key: { label, title?, render(), footer?() } }

  /* ---------------- a11y: focus trap & hotkeys ---------------- */
  function trap(e){
    if (e.key !== 'Tab') return;
    const focusables = backdrop.querySelectorAll('button,[href],input,select,textarea,[tabindex]:not([tabindex="-1"])');
    const list = Array.from(focusables).filter(el => !el.hasAttribute('disabled') && el.offsetParent !== null);
    if (!list.length) return;
    const first = list[0], last = list[list.length-1];
    if (e.shiftKey && document.activeElement === first){ e.preventDefault(); last.focus(); }
    else if (!e.shiftKey && document.activeElement === last){ e.preventDefault(); first.focus(); }
  }
  function onKey(e){ if (e.key === 'Escape') close(); }

  /* ---------------- public: open/close/switch ---------------- */
  function open(defaultKey = null){
    lastFocused = document.activeElement;
    backdrop.dataset.open = "true";
    backdrop.removeAttribute('aria-hidden');
    document.addEventListener('keydown', onKey);
    backdrop.addEventListener('keydown', trap);

    // Default to provided key or first menu item
    const key = (defaultKey && menuConfig[defaultKey]) ? defaultKey : Object.keys(menuConfig)[0];
    switchTo(key);

    // Focus the active item in sidebar so keyboard users can navigate
    setTimeout(() => menuEl?.querySelector('.menu__btn[aria-current="true"]')?.focus(), 0);
  }

  function close(){
    backdrop.dataset.open = "false";
    backdrop.setAttribute('aria-hidden','true');
    document.removeEventListener('keydown', onKey);
    backdrop.removeEventListener('keydown', trap);
    if (lastFocused && lastFocused.focus) lastFocused.focus();
  }

  function switchTo(key){
    const def = menuConfig[key]; if (!def) return;
    currentKey = key;
    titleEl.textContent = def.title || def.label;

    // Swap content + footer
    const nodes = [].concat(def.render());
    contentEl.replaceChildren(...nodes);
    footerEl.replaceChildren(...(def.footer?.() || defaultFooter()));

    highlightCurrent();

    // Focus first interactive for fast entry
    setTimeout(()=>{
      const first = contentEl.querySelector('input,select,textarea,button,[tabindex]:not([tabindex="-1"])');
      if (first) first.focus();
    },0);
  }

  function setMenu(config){
    menuConfig = config;
    renderMenu();
    highlightCurrent();
  }

  /* ---------------- renderers & state sync ---------------- */
  function renderMenu(){
    menuEl.innerHTML = '';
    Object.entries(menuConfig).forEach(([key, def])=>{
      const b = document.createElement('button');
      b.className='menu__btn';
      b.type='button';
      b.textContent=def.label;
      b.dataset.key=key;
      b.addEventListener('click', ()=>switchTo(key));
      menuEl.appendChild(b);
    });
  }

  function highlightCurrent(){
    menuEl.querySelectorAll('.menu__btn').forEach(btn=>{
      btn.setAttribute('aria-current', btn.dataset.key === currentKey ? 'true' : 'false');
    });
  }

  function defaultFooter(){
    const closeBtn = html`<button class="btn" data-action="close" type="button">Close</button>`;
    return [closeBtn];
  }

  /* ---------------- global listeners ---------------- */
  backdrop.addEventListener('click', (e)=>{ if (e.target === backdrop) close(); });
  footerEl.addEventListener('click', (e)=>{ if (e.target.matches('[data-action="close"]')) close(); });

  /* ---------------- tiny HTML helper ---------------- */
  function html(strings,...values){
    const t=document.createElement('template');
    t.innerHTML=strings.map((s,i)=>s+(values[i]??'')).join('').trim();
    return t.content.firstElementChild;
  }

  // Public API
  return { open, close, setMenu, switchTo, el:{backdrop,titleEl,contentEl,footerEl,menuEl}, html };
})();

/* ========================================================================================
   Settings views (edit freely)
======================================================================================== */
const SettingsMenu = {
  setIncome: {
    label: 'Income',
    title: 'Set Daily/Monthly Income',
    render(){
      return [
        elField('Income Amount','number','incomeAmount',{min:0,step:'0.01',placeholder:'e.g. 3200.00'}),
        elSelect('Cadence','incomeCadence',[['monthly','Monthly'],['weekly','Weekly'],['daily','Daily']]),
        helper('This updates your regen baseline and HUD projections.')
      ];
    },
    footer(){ return [ primary('Save',()=>emit('income:save')), cancel() ]; }
  },
  setCoreExpenses: {
    label: 'Core Expenses',
    title: 'Set Core Expenses',
    render(){
      return [
        elField('Core Expenses Amount','number','coreAmount',{min:0,step:'0.01',placeholder:'e.g. 1850.00'}),
        elSelect('Cadence','coreCadence',[['monthly','Monthly'],['weekly','Weekly']]),
        helper('Core expenses inform Health/Mana/Stamina baselines.')
      ];
    },
    footer(){ return [ primary('Save',()=>emit('core:save')), cancel() ]; }
  },
  addTransaction: {
    label: 'Transactions',
    title: 'Add Transaction',
    render(){
      return [
        elField('Description','text','txDesc',{placeholder:'e.g. Groceries'}),
        elField('Amount','number','txAmount',{min:0,step:'0.01',placeholder:'e.g. 23.40'}),
        elSelect('Type','txType',[['debit','Expense'],['credit','Income']]),
        elSelect('Pool (optional)','txPool',[['','Unassigned'],['stamina','Stamina'],['mana','Mana'],['health','Health']]),
        elField('Date','date','txDate',{}),
        helper('If unassigned, fallback routes it: Stamina first, overflow to Health.')
      ];
    },
    footer(){ return [ primary('Add',()=>emit('tx:add')), cancel() ]; }
  },
  connectAccount: {
    label: 'Connect Account',
    title: 'Connect a Bank Account',
    render(){
      return [
        p('Connect a bank via TrueLayer to sync transactions automatically.'),
        Modal.html`<button class="btn btn--accent" type="button" id="btnStartOAuth">Start Connection</button>`,
        helper('You‚Äôll be redirected to your bank to authorise access.')
      ];
    },
    footer(){ return [ cancel() ]; }
  },
  logout: {
    label: 'Log Out',
    title: 'Log Out',
    render(){ return [ p('<strong>Are you sure?</strong> You‚Äôll be signed out from this device.') ]; },
    footer(){ return [ danger('Log Out',()=>emit('auth:logout')), cancel('Cancel') ]; }
  }
};

/* ========================================================================================
   Element helpers + event bus
======================================================================================== */
function elField(labelTxt,type,id,attrs={}){ const w=document.createElement('div'); w.className='field';
  const l=document.createElement('label'); l.htmlFor=id; l.textContent=labelTxt;
  const i=document.createElement('input'); i.className='input'; i.type=type; i.id=id; Object.assign(i,attrs);
  w.append(l,i); return w; }
function elSelect(labelTxt,id,options){ const w=document.createElement('div'); w.className='field';
  const l=document.createElement('label'); l.htmlFor=id; l.textContent=labelTxt;
  const s=document.createElement('select'); s.className='select'; s.id=id;
  options.forEach(([v,t])=>{ const o=document.createElement('option'); o.value=v; o.textContent=t; s.appendChild(o); });
  w.append(l,s); return w; }
function helper(text){ const s=document.createElement('div'); s.className='helper'; s.innerHTML=text; return s; }
function p(text){ const el=document.createElement('div'); el.className='helper'; el.innerHTML=text; return el; }
function btn(label,klass,fn){ const b=document.createElement('button'); b.type='button'; b.className=`btn ${klass||''}`; b.textContent=label; b.addEventListener('click',fn); return b; }
function primary(label,fn){ return btn(label,'btn--accent',fn); }
function cancel(label='Close'){ const b=btn(label,'',()=>Modal.close()); b.dataset.action='close'; return b; }
function danger(label,fn){ return btn(label,'',fn); }
function emit(type){
  const values = {};
  Modal.el.contentEl.querySelectorAll('input,select,textarea').forEach(i=>values[i.id]=i.value);
  window.dispatchEvent(new CustomEvent(type,{ detail: values }));
}

/* ========================================================================================
   Boot: register menu + hook Settings button
======================================================================================== */
Modal.setMenu(SettingsMenu);

// Open with your preferred default view
document.getElementById('settings-btn')?.addEventListener('click',()=>{
  Modal.open('setIncome');
});

// Example app handlers (replace with your Firestore/TrueLayer calls)
window.addEventListener('income:save', e => console.log('Save income', e.detail));
window.addEventListener('core:save',   e => console.log('Save core', e.detail));
window.addEventListener('tx:add',      e => console.log('Add tx', e.detail));
window.addEventListener('auth:logout', () => { console.log('Logout'); Modal.close(); });
document.addEventListener('click', e => { if (e.target?.id==='btnStartOAuth'){ console.log('Start TrueLayer OAuth'); }});
</script>
<!-- ============ /Modal ============ -->



</body>
</html>
