name: Forge Work Order Execute (Issue ‚Üí PR)

on:
  issue_comment:
    types: [created]

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  gate:
    if: contains(github.event.comment.body, '/execute')
    runs-on: ubuntu-latest
    outputs:
      passed: ${{ steps.check-approved.outputs.passed }}
    steps:
      - name: Gate - Only repo members
        uses: actions/github-script@v7
        with:
          script: |
            const actor = context.actor;
            // Require comment author to have write/admin/maintain permissions.
            const perm = await github.rest.repos.getCollaboratorPermissionLevel({
              owner: context.repo.owner,
              repo: context.repo.repo,
              username: actor
            });
            const allowed = ["admin","maintain","write"].includes(perm.data.permission);
            if (!allowed) core.setFailed(`Actor ${actor} lacks permission: ${perm.data.permission}`);

      - name: Gate - Issue must be labeled approved
        id: check-approved
        uses: actions/github-script@v7
        with:
          script: |
            const issue = context.payload.issue;
            const labels = issue.labels.map(l => l.name);
            if (!labels.includes("approved")) {
              core.setFailed(`Issue missing required label: approved. Current labels: ${labels.join(", ")}`);
            }
            core.setOutput("passed", "true");

  execute:
    needs: gate
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Extract Work Order from Issue
        id: extract-wo
        uses: actions/github-script@v7
        with:
          script: |
            const issue = context.payload.issue;
            core.setOutput("issue_number", issue.number);
            core.setOutput("issue_title", issue.title);
            core.setOutput("issue_body", issue.body);
            core.setOutput("issue_url", issue.html_url);

            // Log for visibility
            console.log(`Work Order Issue: #${issue.number}`);
            console.log(`Title: ${issue.title}`);

      - name: Acknowledge execution start
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.issue.number,
              body: `üîß **Forge Executor**: Work Order execution started.\n\nRun: [${context.runId}](${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})\n\n_This is an automated acknowledgment._`
            });

      # ============================================================
      # EXECUTOR PLACEHOLDER
      # ============================================================
      # Replace this step with your repo-aware executor action.
      #
      # The executor should:
      # 1) Parse issue body (Work Order fields)
      # 2) Apply Forge rules (allowed/forbidden paths from WO)
      # 3) Create branch: wo/${{ steps.extract-wo.outputs.issue_number }}
      # 4) Commit changes per the Work Order scope
      # 5) Open PR with execution report
      #
      # Example integration with Claude Code Action (when available):
      # - uses: anthropics/claude-code-action@v1
      #   with:
      #     anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
      #     task: |
      #       Execute the following Work Order. Follow Forge rules.
      #       ${{ steps.extract-wo.outputs.issue_body }}
      #
      # ============================================================
      - name: Executor placeholder
        run: |
          echo "============================================"
          echo "FORGE WORK ORDER EXECUTOR"
          echo "============================================"
          echo ""
          echo "Issue: #${{ steps.extract-wo.outputs.issue_number }}"
          echo "Title: ${{ steps.extract-wo.outputs.issue_title }}"
          echo "URL: ${{ steps.extract-wo.outputs.issue_url }}"
          echo ""
          echo "STATUS: Placeholder - Replace with Claude executor action"
          echo ""
          echo "To complete M2b integration:"
          echo "1. Add ANTHROPIC_API_KEY secret to repository"
          echo "2. Replace this step with claude-code-action"
          echo "3. Configure allowed/forbidden path enforcement"
          echo "============================================"

      - name: Report execution status
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const status = '${{ job.status }}';
            const emoji = status === 'success' ? '‚úÖ' : '‚ùå';
            const message = status === 'success'
              ? 'Execution completed (placeholder mode).'
              : 'Execution failed. Check workflow logs.';

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.issue.number,
              body: `${emoji} **Forge Executor**: ${message}\n\nRun: [${context.runId}](${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})`
            });
