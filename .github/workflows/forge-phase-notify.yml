name: Forge Phase Transition Notifications

on:
  issues:
    types: [labeled]

permissions:
  contents: read
  issues: write

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - name: Detect Phase Transition
        id: phase
        uses: actions/github-script@v7
        with:
          script: |
            const label = context.payload.label?.name;
            const issue = context.payload.issue;
            const labels = issue.labels.map(l => l.name);

            // Only process Work Order issues
            if (!labels.includes("work-order")) {
              console.log("Not a Work Order issue, skipping");
              return;
            }

            // E2E Phase definitions (from E2E_WORKFLOW_PLAYBOOK.md)
            const phases = {
              "pending-approval": {
                phase: "Draft",
                icon: "üìù",
                role: "Architect",
                next: "approved",
                message: "Work Order submitted for approval"
              },
              "approved": {
                phase: "Approved",
                icon: "‚úÖ",
                role: "Director",
                next: "ready-for-executor",
                message: "Work Order APPROVED by Director"
              },
              "ready-for-executor": {
                phase: "Queued",
                icon: "üìã",
                role: "Forge",
                next: "executing",
                message: "Work Order queued for Executor"
              },
              "executing": {
                phase: "Executing",
                icon: "‚öôÔ∏è",
                role: "Executor",
                next: "executed",
                message: "Executor has picked up this Work Order"
              },
              "executed": {
                phase: "Executed",
                icon: "üîß",
                role: "Executor",
                next: "verified",
                message: "Execution complete, pending verification"
              },
              "verified": {
                phase: "Verified",
                icon: "üîç",
                role: "Verifier-Tester",
                next: "deployed-dev",
                message: "Work Order verified by Verifier-Tester"
              },
              "deployed-dev": {
                phase: "Deployed Dev",
                icon: "üñ•Ô∏è",
                role: "Automation",
                next: "promoted",
                message: "Deployed to DEV environment"
              },
              "promoted": {
                phase: "Promoted",
                icon: "üöÄ",
                role: "Director",
                next: "deployed-prod",
                message: "PROMOTED to production by Director"
              },
              "deployed-prod": {
                phase: "Deployed Prod",
                icon: "üéØ",
                role: "Automation",
                next: "observed",
                message: "Deployed to PRODUCTION"
              },
              "observed": {
                phase: "Observed",
                icon: "üìä",
                role: "Reporter",
                next: "evolved",
                message: "Observation period active"
              },
              "evolved": {
                phase: "Evolved",
                icon: "üí°",
                role: "Evolution Agent",
                next: null,
                message: "Evolution proposals captured"
              }
            };

            // Check if the applied label is a phase label
            const phaseInfo = phases[label];
            if (!phaseInfo) {
              console.log(`Label "${label}" is not a phase label, skipping`);
              return;
            }

            // Extract Work Order ID from issue title or body
            const woIdMatch = issue.title.match(/\[WO\]\s*(.+)/i) ||
                              issue.body?.match(/Work Order ID[:\s]+([^\n]+)/i);
            const woId = woIdMatch ? woIdMatch[1].trim() : `#${issue.number}`;

            // Build notification comment
            const divider = "‚îÄ".repeat(40);
            const runUrl = `${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`;

            const lines = [
              `## ${phaseInfo.icon} Phase Transition: ${phaseInfo.phase}`,
              "",
              `**Work Order:** ${woId}`,
              `**Phase:** \`${label}\` ‚Üí ${phaseInfo.phase}`,
              `**Role:** ${phaseInfo.role}`,
              "",
              divider,
              "",
              `### ${phaseInfo.message}`,
              "",
              phaseInfo.next ? `**Next Phase:** \`${phaseInfo.next}\`` : "**Final Phase** ‚Äî Work Order lifecycle complete",
              "",
              divider,
              `_Phase notification by Forge ‚Ä¢ [Run #${context.runId}](${runUrl})_`
            ];

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issue.number,
              body: lines.join("\n")
            });

            console.log(`Phase transition notification posted: ${label} ‚Üí ${phaseInfo.phase}`);
            core.setOutput("phase", phaseInfo.phase);
            core.setOutput("label", label);
