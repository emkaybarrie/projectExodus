name: "[DEPRECATED] Project Exodus → GitHub Pages"

# ==============================================================================
# DEPRECATED: This workflow has been superseded by forge-pages-deploy.yml
# which deploys both PROD (/) and DEV (/dev/) in a single Pages artifact.
# This file is kept for reference only.
# ==============================================================================

on:
  workflow_dispatch:
    inputs:
      run_anyway:
        description: 'This workflow is deprecated. Use forge-pages-deploy.yml instead.'
        type: boolean
        default: false

# Disabled automatic triggers - now handled by forge-pages-deploy.yml
# on:
#   push:
#     branches: ["main"]
#     paths:
#       - "index.html"
#       - ... etc

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: true

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      # Generate fresh Share Pack indices before deploy
      - name: Generate Share Pack (ensures fresh indices)
        run: |
          echo "=== Generating Share Pack for production deploy ==="
          node "The Forge/forge/ops/scripts/refresh-share-pack.mjs"
          echo "✅ Share Pack generated"

      - name: Validate JSON indices exist
        run: |
          if [ ! -f "The Forge/forge/exports/share-pack/share-pack.index.json" ]; then
            echo "❌ share-pack.index.json missing"
            exit 1
          fi
          if [ ! -f "The Forge/forge/exports/share-pack/work-orders.index.json" ]; then
            echo "❌ work-orders.index.json missing"
            exit 1
          fi
          echo "✅ JSON indices present"

      - name: Configure Pages
        uses: actions/configure-pages@v5

      # Upload entire repo as Pages artifact (includes fresh indices)
      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: "."

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

      - name: Deployment summary
        run: |
          echo "============================================"
          echo "PRODUCTION DEPLOYMENT COMPLETE"
          echo "============================================"
          echo "URL: ${{ steps.deployment.outputs.page_url }}"
          echo "Portal: ${{ steps.deployment.outputs.page_url }}The%20Forge/forge/portal/"
          echo "============================================"
